name: Bun Linux Compile & Package # å·¥ä½œæµåç§°
on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    
jobs:
  build-linux-executable: # ä½œä¸š ID
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨ä¸Šæ‰§è¡Œ

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Install Bun
        uses: oven-sh/setup-bun@v1
        
      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile # å®‰è£…é¡¹ç›®ä¾èµ–ï¼Œå¹¶ä½¿ç”¨ lockfile ç¡®ä¿ç‰ˆæœ¬ä¸€è‡´

      - name: ğŸ”¨ Compile Bun Executable for Linux
        # ä½¿ç”¨ bun build --compile ç¼–è¯‘ä¸ºç‹¬ç«‹çš„ Linux å¯æ‰§è¡Œæ–‡ä»¶
        run: bun build ./src/index.ts --compile --target=bun-linux-x64 --outfile hono-server
        # æ³¨æ„ï¼šæ­¤æ­¥éª¤åªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ (hono-server)ï¼Œé™æ€æ–‡ä»¶ä¸ä¼šè¢«è‡ªåŠ¨åŒ…å«ã€‚

      - name: ğŸ”‘ Set Permissions (é‡è¦!)
        run: chmod +x hono-server # èµ‹äºˆå¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œæƒé™

      - name: ğŸ“¦ Create Distribution Package (åŒ…å«å¯æ‰§è¡Œæ–‡ä»¶å’Œ public ç›®å½•)
        run: |
          # 1. åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åˆ†å‘ç›®å½•
          mkdir -p dist_package
          
          # 2. å¤åˆ¶ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶åˆ°åˆ†å‘ç›®å½•
          cp hono-server dist_package/
          
          # 3. å¤åˆ¶æ‰€æœ‰é™æ€èµ„æºï¼ˆä¾‹å¦‚ public ç›®å½•ï¼‰åˆ°åˆ†å‘ç›®å½•
          # **å‡è®¾æ‚¨çš„é™æ€æ–‡ä»¶åœ¨åä¸º 'public' çš„ç›®å½•ä¸‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¯·ä¿®æ”¹è¿™é‡Œçš„è·¯å¾„**
          if [ -d "public" ]; then
            cp -r public dist_package/
          fi
          
          # 4. å°†æ•´ä¸ªåˆ†å‘ç›®å½•å‹ç¼©æˆ ZIP æ–‡ä»¶
          zip -r linux-server-package.zip dist_package

      - name: â¬†ï¸ Upload Artifact (ä¸‹è½½åˆ¶å“)
        uses: actions/upload-artifact@v4
        with:
          name: linux-server-package # åˆ¶å“åç§°ï¼Œç°åœ¨æ˜¯ä¸€ä¸ª ZIP åŒ…
          path: linux-server-package.zip # ä¸Šä¼ ç”Ÿæˆçš„ ZIP æ–‡ä»¶
          retention-days: 7 # åˆ¶å“ä¿ç•™å¤©æ•°
